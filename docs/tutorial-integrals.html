<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Integrals - The Nutils Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">The Nutils Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/evalf/nutils-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="integrals"><a class="header" href="#integrals">Integrals</a></h1>
<p>A central operation in any Finite Element application is to integrate a
function over a physical domain. In Nutils, integration starts with the
topology, in particular the <code>integral()</code> method.</p>
<p>The integral method takes a <code>nutils.function.Array</code> function as first argument
and the degree as keyword argument. The function should contain the Jacobian of
the geometry against which the function should be integrated, using either
<code>nutils.function.J</code> or <code>dV</code> in a namespace expression (assuming the jacobian
has been added to the namespace using <code>ns.define_for(..., jacobians=('dV', 'dS'))</code>). For example, the following integrates <code>1</code> against geometry <code>x</code>:</p>
<pre><code class="language-python">I = topo.integral('1 dV' @ ns, degree=0)
# Array&lt;&gt;
</code></pre>
<p>The resulting <code>nutils.function.Array</code> object is a representation of the
integral, as yet unevaluated. To compute the actual numbers, use the
<code>function.eval()</code> function:</p>
<pre><code class="language-python">function.eval(I)
# 1.0
</code></pre>
<p>Be careful with including the Jacobian in your integrands.  The following two
integrals are different:</p>
<pre><code class="language-python">function.eval(topo.integral('(1 + 1) dV' @ ns, degree=0))
# 2.0
function.eval(topo.integral('1 + 1 dV' @ ns, degree=0))
# 5.0
</code></pre>
<p>Like any other <code>nutils.function.Array</code>, the integrals can be added or
subtracted:</p>
<pre><code class="language-python">J = topo.integral('x_0 dV' @ ns, degree=1)
function.eval(I+J)
# 1.5
</code></pre>
<p>Recall that a topology boundary is also a <code>nutils.topology.Topology</code> object,
and hence it supports integration.  For example, to integrate the geometry <code>x</code>
over the entire boundary, write</p>
<pre><code class="language-python">function.eval(topo.boundary.integral('x_0 dS' @ ns, degree=1))
# 1.0
</code></pre>
<p>To limit the integral to the right boundary, write</p>
<pre><code class="language-python">function.eval(topo.boundary['right'].integral('x_0 dS' @ ns, degree=1))
# 1.0
</code></pre>
<p>Note that this boundary is simply a point and the integral a point evaluation.</p>
<h2 id="back-to-our-discrete-solution"><a class="header" href="#back-to-our-discrete-solution">Back to our discrete solution</a></h2>
<p>We observed earlier that we cannot evaluate our discrete solution because of
lacking a specification of topological points -- or in Nutils jargon: leaving a
<em>space</em> unbound. Integrals provide this information by defining the set of
quadrature points that the function will be evaluated in (followed by a
contraction with quadrature weights). This means we could aim to evaluate the
following function:</p>
<pre><code class="language-python">f = topo.integral('∇_k(u) ∇_k(u) dV' @ ns, degree=1)
</code></pre>
<p>However, to do so we do need to provide the weights for argument 'u'. We do
this as follows:</p>
<pre><code class="language-python">function.eval(f, arguments={'u': [1,2,0,5,4]})
</code></pre>
<p>Since integrals are <code>nutils.function.Array</code> objects, integrals involving
arguments support derivatives. Taking the derivative once results in a 1D
function, which evaluates to a <code>numpy.ndarray</code>:</p>
<pre><code class="language-python">function.eval(f.derivative('u'), arguments={'u': [1,2,0,5,4]})
# array([0.125, 0.25 , 0.25 , 0.25 , 0.125])
</code></pre>
<p>Since our function <code>f</code> is quadratic in 'u', the second derivative becomes
constant (i.e. independent of arguments) and can be evaluated without any
argument specification:</p>
<pre><code class="language-python">M = f.derivative('u').derivative('u')
function.eval(M)
# array([[ 4., -4.,  0.,  0.,  0.],
#        [-4.,  8., -4.,  0.,  0.],
#        [ 0., -4.,  8., -4.,  0.],
#        [ 0.,  0., -4.,  8., -4.],
#        [ 0.,  0.,  0., -4.,  4.]])
</code></pre>
<p>Observing that this matrix is sparse, it would be more efficient to evaluate
only the nonzero entries and the corresponding indices, so that these can be
used to form an appropriate sparse matric object. For this, the
<code>nutils.function</code> module provides the two modifiers <code>as_coo</code> and <code>as_csr</code>.
The former is valid for objects of any dimension, and return the nonzero values
followed by a number of index vectors equal to the dimension of the array:</p>
<pre><code class="language-python">function.eval(function.as_coo(M))
# (array([ 8., -8., -8., 16., -8., -8., 16., -8., -8., 16., -8., -8.,  8.]),
#  array([0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4]),
#  array([0, 1, 0, 1, 2, 1, 2, 3, 2, 3, 4, 3, 4]))
</code></pre>
<p>The latter of specific to 2D arrays and returns the sparsity structure in
<a href="https://en.wikipedia.org/wiki/Sparse_matrix#Compressed_sparse_row_(CSR,_CRS_or_Yale_format)">compressed sparse
row</a>
format:</p>
<pre><code class="language-python">function.eval(function.as_csr(M))
# (array([ 8., -8., -8., 16., -8., -8., 16., -8., -8., 16., -8., -8.,  8.]),
#  array([ 0,  2,  5,  8, 11, 13]),
#  array([0, 1, 0, 1, 2, 1, 2, 3, 2, 3, 4, 3, 4]))
</code></pre>
<p>Either of these can be used to form a Nutils sparse matrix using the
<code>nutils.matrix.assemble_coo</code> or <code>nutils.matrix.assemble_csr</code> functions, or
any third party sparse matrix of preference.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="tutorial-namespace.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="tutorial-solvers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="tutorial-namespace.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="tutorial-solvers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
