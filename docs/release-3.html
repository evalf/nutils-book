<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Nutils 3 Dragon Beard - The Nutils Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">The Nutils Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/evalf/nutils-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="nutils-3-dragon-beard"><a class="header" href="#nutils-3-dragon-beard">Nutils 3 Dragon Beard</a></h1>
<p>Nutils 3 was released on August 22nd, 2018 and saw one point release for fixes
and backports. The most recent and final version in this series is Nutils 3.1,
released on February 5th, 2018.</p>
<ul>
<li><a href="https://github.com/evalf/nutils/archive/refs/tags/v3.1.zip">Download</a> (zip)</li>
<li><a href="https://docs.nutils.org/en/v3.1/">API Reference</a></li>
</ul>
<h2 id="whats-new"><a class="header" href="#whats-new">What's New?</a></h2>
<p>These are the main additions and changes since <a href="release-2.html">Nutils 2 Chuka
Men</a>.</p>
<h3 id="new-functionnamespace"><a class="header" href="#new-functionnamespace">New: function.Namespace</a></h3>
<p>The <code>nutils.function.Namespace</code> object represents a container of
<code>nutils.function.Array</code> instances:</p>
<pre><code class="language-python">ns = function.Namespace()
ns.x = geom
ns.basis = domain.basis('std', degree=1).vector(2)
</code></pre>
<p>In addition to bundling arrays, arrays can be manipulated using index notation
via string expressions using the <code>nutils.expression</code> syntax:</p>
<pre><code class="language-python">ns.sol_i = 'basis_ni ?dofs_n'
f = ns.eval_i('sol_i,j n_j')
</code></pre>
<h3 id="new-topologyintegral"><a class="header" href="#new-topologyintegral">New: Topology.integral</a></h3>
<p>Analogous to <code>nutils.topology.Topology.integrate</code>, which integrates a function
and returns the result as a (sparse) array, the new method
<code>nutils.topology.Topology.integral</code> with identical arguments results in an
<code>nutils.sample.Integral</code> object for postponed evaluation:</p>
<pre><code class="language-python">x = domain.integrate(f, geometry=geom, degree=2) # direct
integ = domain.integral(f, geometry=geom, degree=2) # indirect
x = integ.eval()
</code></pre>
<p>Integral objects support linear transformations, derivatives and substitutions.
Their main use is in combination with routines from the <code>nutils.solver</code> module.</p>
<h3 id="removed-transformchain-canonicaltransformchain"><a class="header" href="#removed-transformchain-canonicaltransformchain">Removed: TransformChain, CanonicalTransformChain</a></h3>
<p>Transformation chains (sequences of transform items) are stored as standard
tuples. Former class methods are replaced by module methods:</p>
<pre><code class="language-python">elem.transform.promote(ndims) # no longer valid
transform.promote(elem.transform, ndims) # new syntax
</code></pre>
<p>In addition, every <code>edge_transform</code> and <code>child_transform</code> of Reference objects
is changed from (typically unit-length) <code>TransformChain</code> to
<code>nutils.transform.TransformItem</code>.</p>
<h3 id="changed-command-line-interface"><a class="header" href="#changed-command-line-interface">Changed: command line interface</a></h3>
<p>Command line parsers <code>nutils.cli.run</code> or <code>nutils.cli.choose</code> dropped support
for space separated arguments (--arg value), requiring argument and value to be
joined by an equals sign instead:</p>
<pre><code class="language-sh">python script.py --arg=value
</code></pre>
<p>Boolean arguments are specified by omitting the value and prepending 'no' to
the argument name for negation:</p>
<pre><code class="language-sh">python script.py --pdb --norichoutput
</code></pre>
<p>For convenience, leading dashes have been made optional:</p>
<pre><code class="language-sh">python script.py arg=value pdb norichoutput
</code></pre>
<h3 id="new-topology-intersections-deprecates-common_refinement"><a class="header" href="#new-topology-intersections-deprecates-common_refinement">New: Topology intersections (deprecates common_refinement)</a></h3>
<p>Intersections between topologies can be made using the <code>&amp;</code> operator. In case
the operands have different refinement patterns, the resulting topology will
consist of the common refinements of the intersection:</p>
<pre><code class="language-python">intersection = topoA &amp; topoB
interface = topo['fluid'].boundary &amp; ~topo['solid'].boundary
</code></pre>
<h3 id="changed-topologyindicator"><a class="header" href="#changed-topologyindicator">Changed: Topology.indicator</a></h3>
<p>The <code>nutils.topology.Topology.indicator</code> method is moved from subtopology to
parent topology, i.e. the topology you want to evaluate the indicator on, and
now takes the subtopology is an argument:</p>
<blockquote>
<blockquote>
<blockquote>
<p>ind = domain.boundary['top'].indicator() # no longer valid
ind = domain.boundary.indicator(domain.boundary['top']) # new syntax
ind = domain.boundary.indicator('top') # equivalent shorthand</p>
</blockquote>
</blockquote>
</blockquote>
<h3 id="changed-evaluableeval"><a class="header" href="#changed-evaluableeval">Changed: Evaluable.eval</a></h3>
<p>The <code>nutils.function.Evaluable.eval</code> method accepts a flexible number of
keyword arguments, which are accessible to <code>evalf</code> by depending on the
<code>EVALARGS</code> token. Standard keywords are <code>_transforms</code> for transformation
chains, <code>_points</code> for integration points, and <code>_cache</code> for the cache object:</p>
<pre><code class="language-python">f.eval(elem, 'gauss2') # no longer valid
ip, iw = elem.getischeme('gauss2')
tr = elem.transform, elem.opposite
f.eval(_transforms=tr, _points=ip) # new syntax
</code></pre>
<h3 id="new-numericconst"><a class="header" href="#new-numericconst">New: numeric.const</a></h3>
<p>The <code>numeric.const</code> array represents an immutable, hashable array:</p>
<pre><code class="language-python">A = numeric.const([[1,2],[3,4]])
d = {A: 1}
</code></pre>
<p>Existing arrays can be wrapped into a <code>const</code> object by adding <code>copy=False</code>.
The <code>writeable</code> flag of the original array is set to False to prevent
subsequent modification:</p>
<pre><code class="language-python">A = numpy.array([1,2,3])
Aconst = numeric.const(A, copy=False)
A[1] = 4
# ValueError: assignment destination is read-only
</code></pre>
<h3 id="new-function-annotations"><a class="header" href="#new-function-annotations">New: function annotations</a></h3>
<p>The <code>util.enforcetypes</code> decorator applies conversion methods to annotated
arguments:</p>
<pre><code class="language-python">@util.enforcetypes
def f(a:float, b:tuple)
  print(type(a), type(b))
f(1, [2])
# &lt;class 'float'&gt; &lt;class 'tuple'&gt;
</code></pre>
<p>The decorator is by default active to constructors of cache.Immutable
derived objects, such as function.Evaluable.</p>
<h3 id="changed-evaluable_edit"><a class="header" href="#changed-evaluable_edit">Changed: Evaluable._edit</a></h3>
<p>Evaluable objects have a default edit implementation that re-instantiates the
object with the operand applied to all constructor arguments. In situations
where the default implementation is not sufficient it can be overridden by
implementing the <code>edit</code> method (note: without the underscore):</p>
<pre><code class="language-python">class B(function.Evaluable):
  def __init__(self, d):
    assert isinstance(d, dict)
    self.d = d
  def edit(self, op):
    return B({key: op(value) for key, value in self.d.items()})
</code></pre>
<h3 id="changed-function-derivatives"><a class="header" href="#changed-function-derivatives">Changed: function derivatives</a></h3>
<p>The <code>nutils.function.derivative</code> <code>axes</code> argument has been removed;
<code>derivative(func, var)</code> now takes the derivative of <code>func</code> to all the axes in
<code>var</code>:</p>
<pre><code class="language-python">der = function.derivative(func, var,
        axes=numpy.arange(var.ndim)) # no longer valid
der = function.derivative(func, var) # new syntax
</code></pre>
<h3 id="new-module-cli"><a class="header" href="#new-module-cli">New module: cli</a></h3>
<p>The <code>nutils.util.run</code> function is deprecated and replaced by two new functions,
<code>nutils.cli.choose</code> and <code>nutils.cli.run</code>. The new functions are very similar to
the original, but have a few notable differences:</p>
<ul>
<li><code>cli.choose</code> requires the name of the function to be executed (typically
'main'), followed by any optional arguments</li>
<li><code>cli.run</code> does not require the name of the function to be executed, but only
a single one can be specified</li>
<li>argument conversions follow the type of the argument's default value, instead
of the result of <code>eval</code></li>
<li>the <code>--tbexplore</code> option for post-mortem debugging is replaced by <code>--pdb</code>,
replacing Nutils' own traceback explorer by Python's builtin debugger</li>
<li>on-line debugging is provided via the ctrl+c signal handler</li>
<li>function annotations can be used to describe arguments in both help messages
and logging output (see examples)</li>
</ul>
<h3 id="new-module-solver"><a class="header" href="#new-module-solver">New module: solver</a></h3>
<p>The <code>nutils.solver</code> module provides infrastructure to facilitate formulating
and solving complicated nonlinear problems in a structured and largely
automated fashion.</p>
<h3 subdomain,boundary,interfaces,points="">New: topology.with</h3>
<p>Topologies have been made fully immutable, which means that the old setitem
operation is no longer supported. Instead, to add a subtopology to the domain,
its boundary, its interfaces, or points, any of the methods <code>withsubdomain</code>,
<code>withboundary</code>, <code>withinterfaces</code>, and <code>withpoints</code>, respectively, will return a
copy of the topology with the desired groups added:</p>
<pre><code class="language-python">topo.boundary['wall'] = topo.boundary['left,top'] # no longer valid
newtopo = topo.withboundary(wall=topo.boundary['left,top']) # new syntax
newtopo = topo.withboundary(wall='left,top') # equivalent shorthand
newtopo.boundary['wall'].integrate(...)
</code></pre>
<h3 id="new-circular-symmetry"><a class="header" href="#new-circular-symmetry">New: circular symmetry</a></h3>
<p>Any topology can be revolved using the new <code>nutils.topology.Topology.revolved</code>
method, which interprets the first geometry dimension as a radius and replaces
it by two new dimensions, shifting the remaining axes backward. In addition to
the modified topology and geometry, simplifying function is returned as the
third return value which replaces all occurrences of the revolution angle by
zero. This should only be used after all gradients have been computed:</p>
<pre><code class="language-python">rdomain, rgeom, simplify = domain.revolved(geom)
basis = rdomain.basis('spline', degree=2)
M = function.outer(basis.grad(rgeom)).sum(-1)
rdomain.integrate(M, geometry=rgeom, ischeme='gauss2', edit=simplify)
</code></pre>
<h3 id="renamed-meshgmesh-to-meshgmsh-added-support-for-periodicity"><a class="header" href="#renamed-meshgmesh-to-meshgmsh-added-support-for-periodicity">Renamed mesh.gmesh to mesh.gmsh; added support for periodicity</a></h3>
<p>The gmsh importer was unintentionally misnamed as gmesh; this has been fixed.
With that the old name is deprecated and will be removed in future. In
addition, support for the non-physical mesh format and externally supplied
boundary labels has been removed (see the unit test tests/mesh.py for examples
of valid .geo format). Support is added for periodicity and interface groups.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="release-4.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="release-2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="release-4.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="release-2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
